<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pia's Mini Piano</title>
    <link rel="icon" type="image/png" href="misc/icons8-feather-55.png">
    <style>
        body { background: #0b0b0b; color: #fff; font-family: 'Inter', system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden;}
        
        #hud { display: flex; align-items: center; gap: 40px; background: #161616; padding: 25px 50px; border-radius: 20px; border: 1px solid #333; margin-bottom: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .mode-container { display: flex; background: #000; padding: 6px; border-radius: 12px; border: 1px solid #444; }
        .mode-btn { 
            padding: 12px 30px; border: none; background: none; color: #555; 
            cursor: pointer; font-weight: 800; font-size: 0.9rem; transition: 0.2s; border-radius: 8px;
            letter-spacing: 1px;
        }
        .mode-btn.active { background: #00d1ff; color: #000; }
        
        .info-box { text-align: left; min-width: 150px; }
        .label { font-size: 0.65rem; color: #888; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .val { font-family: monospace; font-size: 1.1rem; color: #00d1ff; }

        .piano { display: flex; position: relative; background: #000; padding: 15px; border-radius: 15px; border-top: 12px solid #222; }
        .key-white { width: 48px; height: 200px; background: #fff; border: 1px solid #bbb; border-radius: 0 0 6px 6px; z-index: 1; position: relative; }
        .key-black { width: 30px; height: 125px; background: #222; margin-left: -15px; margin-right: -15px; z-index: 2; border-radius: 0 0 4px 4px; }
        
        .active-white { background: #00d1ff !important; transform: translateY(2px); }
        .active-black { background: #ff4757 !important; transform: translateY(2px); }
        .key-notate { position: absolute; bottom: 12px; width: 100%; text-align: center; color: #aaa; font-size: 11px; font-weight: bold; pointer-events: none; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="info-box">
            <span class="label">Hardware Input</span>
            <div id="dev-name" class="val">Click to Start</div>
        </div>

        <div class="mode-container">
            <button id="btnTenor" class="mode-btn active" onclick="setSpecificMode('tenor')">TENOR (C3)</button>
            <button id="btnSoprano" class="mode-btn" onclick="setSpecificMode('soprano')">SOPRANO (C4)</button>
        </div>

        <div class="info-box">
            <span class="label">Visual Range</span>
            <div id="range-val" class="val">C3 - G5</div>
        </div>
    </div>

    <div class="piano" id="piano"></div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const pianoEl = document.getElementById('piano');
        const devName = document.getElementById('dev-name');
        const rangeVal = document.getElementById('range-val');

        let currentMode = 'tenor';
        let currentStartNote = 48; 
        const NUM_KEYS = 32;
        const samples = {};
        const activeNodes = new Map();
        const keyElements = [];
        const pattern = [0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0];

        // Handles Spacebar toggling
        function toggleMode() {
            const nextMode = (currentMode === 'tenor') ? 'soprano' : 'tenor';
            setSpecificMode(nextMode);
        }

        // Handles specific selection (Mouse click or Spacebar target)
        function setSpecificMode(mode) {
            currentMode = mode;
            currentStartNote = (mode === 'tenor') ? 48 : 60;
            
            document.getElementById('btnTenor').classList.toggle('active', currentMode === 'tenor');
            document.getElementById('btnSoprano').classList.toggle('active', currentMode === 'soprano');
            rangeVal.innerText = (currentMode === 'tenor') ? "C3 - G5" : "C4 - G6";
            
            updateLabels();
            keyElements.forEach(k => k.el.classList.remove('active-white', 'active-black'));
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault(); 
                toggleMode();
            }
        });

        function buildUI() {
            for (let i = 0; i < NUM_KEYS; i++) {
                const key = document.createElement('div');
                const label = document.createElement('div');
                label.className = 'key-notate';
                key.appendChild(label);
                pianoEl.appendChild(key);
                keyElements.push({ el: key, label: label });
            }
            updateLabels();
        }

        function updateLabels() {
            keyElements.forEach((item, i) => {
                const noteValue = currentStartNote + i;
                item.el.className = pattern[noteValue % 12] ? 'key-black' : 'key-white';
                item.label.innerText = (noteValue % 12 === 0) ? `C${Math.floor(noteValue/12)-1}` : '';
            });
        }

        async function loadPiano() {
            devName.innerText = "Loading Audio...";
            const map = {36:'C2', 48:'C3', 60:'C4', 64:'E4', 67:'G4', 72:'C5', 76:'E5', 79:'G5', 84:'C6', 96:'C7'};
            for (let [note, file] of Object.entries(map)) {
                try {
                    const res = await fetch(`https://gleitz.github.io/midi-js-soundfonts/FatBoy/acoustic_grand_piano-mp3/${file}.mp3`);
                    samples[note] = await audioCtx.decodeAudioData(await res.arrayBuffer());
                } catch(e) { console.error("Failed to load sample", file); }
            }
            devName.innerText = "Ready!";
            setupMIDI();
        }

        function setupMIDI() {
            navigator.requestMIDIAccess().then(access => {
                for (let input of access.inputs.values()) {
                    devName.innerText = input.name;
                    input.onmidimessage = handleMIDI;
                }
            });
        }

        function handleMIDI(m) {
            const [cmd, rawNote, vel] = m.data;
            const type = cmd & 0xf0;

            const physicalOffset = rawNote - 60; 
            const virtualNote = currentStartNote + physicalOffset;

            if (type === 144 && vel > 0) {
                playAudio(virtualNote, vel);
                updateVisual(virtualNote, true);
            } else if (type === 128 || (type === 144 && vel === 0)) {
                stopAudio(virtualNote);
                updateVisual(virtualNote, false);
            }
        }

        function playAudio(note, vel) {
            const loaded = Object.keys(samples).map(Number);
            if (loaded.length === 0) return;
            const closest = loaded.reduce((p, c) => Math.abs(c-note) < Math.abs(p-note) ? c : p);
            const src = audioCtx.createBufferSource();
            const gain = audioCtx.createGain();
            src.buffer = samples[closest];
            src.detune.value = (note - closest) * 100;
            gain.gain.value = (vel / 127) * 1.5;
            src.connect(gain).connect(audioCtx.destination);
            src.start(0);
            activeNodes.set(note, { src, gain });
        }

        function stopAudio(note) {
            const node = activeNodes.get(note);
            if (node) {
                node.gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                node.src.stop(audioCtx.currentTime + 0.3);
                activeNodes.delete(note);
            }
        }

        function updateVisual(note, active) {
            const relIndex = note - currentStartNote;
            if (relIndex >= 0 && relIndex < NUM_KEYS) {
                const item = keyElements[relIndex];
                const cls = item.el.classList.contains('key-white') ? 'active-white' : 'active-black';
                active ? item.el.classList.add(cls) : item.el.classList.remove(cls);
            }
        }

        buildUI();
        window.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (Object.keys(samples).length === 0) loadPiano();
        }, { once: true });
    </script>
</body>
</html>