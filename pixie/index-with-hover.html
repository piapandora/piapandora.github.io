<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pixie Squares</title>
<link rel="icon" type="image/png" href="misc/icons8-feather-55.png">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    height:100%;width:100%;
    background:#222;
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;position:relative;
    color:white;font-family:sans-serif;font-size:1.2rem;
    text-align:center;
    transition: background 0.3s ease;
  }
  #grid{display:grid;gap:0;}
  .cell{width:100%;height:100%}
  .c-0 { background:#1a1a4d }
  .c-1 { background:#1a1a4d }
  .c-2 { background:#2a2a66 }
  .c-3 { background:#3b3b80 }
  .c-4 { background:#5555a0 }
  .c-5 { background:#7070b8 }
  .c-6 { background:#8c8cd0 }
  .c-7 { background:#a8a8e6 }
  .c-8 { background:#ccccff }
  .c-9 { background:#ccccff }
  #messageWrapper {
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    pointer-events:none;
    max-width:90%;
    line-height:1.5;
    background:rgba(0,0,0,0.7);
    border-radius:16px;
    padding:20px 30px;
    box-shadow:0 8px 20px rgba(0,0,0,0.7);
    transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
  }
  /* Noticeable hover effect */
  #messageWrapper:hover {
    transform: translate(-50%, -50%) scale(1.08);
    box-shadow: 0 12px 30px rgba(255,221,85,0.6);
    cursor: pointer;
  }
  #messageWrapper span{ font-size:0.9rem; opacity:0.85; }
  #messageWrapper b{ color:#ffdd55; text-shadow:0 0 6px rgba(255,221,85,0.6); }
  canvas{display:none}
</style>
</head>
<body>

<div id="grid"></div>
<div id="messageWrapper">
  <div id="message">
    Drop your Image here<br><br>
    <span>
      Press <b>Spacebar</b> for Wallpaper Mode<br>
      Press <b>Enter</b> to download your Pixie
    </span>
  </div>
</div>
<canvas id="hiddenCanvas"></canvas>

<script>
const MAX_COLS = 160;
const MAX_ROWS = 90;
const grid = document.getElementById('grid');
const messageWrapper = document.getElementById('messageWrapper');
const hiddenCanvas = document.getElementById('hiddenCanvas');
let lastImage = null;
let lastImageArray = null;
let currentCols = MAX_COLS;
let currentRows = MAX_ROWS;
let blackMode = true;
let lastDroppedJson = null;

function brightnessToIndex(r,g,b){ return Math.min(Math.floor((r+g+b)/3 /26),9); }
function getColor(i){ return ['#1a1a4d','#1a1a4d','#2a2a66','#3b3b80','#5555a0','#7070b8','#8c8cd0','#a8a8e6','#ccccff','#ccccff'][i]||'#000'; }

function drawImage(imageArray, cols, rows, offsetX=0, offsetY=0){
  lastImageArray = imageArray;
  currentCols = cols;
  currentRows = rows;
  messageWrapper.style.display = 'none';
  grid.innerHTML = '';
  grid.style.gridTemplateColumns = `repeat(${cols},1fr)`;
  grid.style.gridTemplateRows = `repeat(${rows},1fr)`;
  grid.style.width = `calc(min(100vw / ${cols}, 100vh / ${rows}) * ${cols})`;
  grid.style.height = `calc(min(100vw / ${cols}, 100vh / ${rows}) * ${rows})`;
  const frag=document.createDocumentFragment();
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const index=(y-offsetY)*cols+(x-offsetX);
      const v=imageArray[index]??0;
      const d=document.createElement('div'); d.className='cell c-'+v;
      frag.appendChild(d);
    }
  }
  grid.appendChild(frag);
}

function processImage(img){
  let cols, rows;
  if(blackMode){
    if(img.width>=img.height){ cols=MAX_COLS; rows=Math.round(img.height*(MAX_COLS/img.width)); }
    else { rows=MAX_ROWS; cols=Math.round(img.width*(MAX_ROWS/img.height)); }
    cols=Math.max(1,Math.min(MAX_COLS,cols|0));
    rows=Math.max(1,Math.min(MAX_ROWS,rows|0));
  } else { cols=MAX_COLS; rows=MAX_ROWS; }
  const cv=document.createElement('canvas'); cv.width=cols; cv.height=rows;
  const ctx=cv.getContext('2d'); ctx.drawImage(img,0,0,cols,rows);
  const data=ctx.getImageData(0,0,cols,rows).data;
  const arr=[];
  for(let i=0;i<data.length;i+=4) arr.push(brightnessToIndex(data[i],data[i+1],data[i+2]));
  return { arr, cols, rows };
}

function padTo160x90(arr,nativeCols,nativeRows){
  const fullArray=Array(MAX_COLS*MAX_ROWS).fill(0);
  const offsetX=Math.floor((MAX_COLS-nativeCols)/2);
  const offsetY=Math.floor((MAX_ROWS-nativeRows)/2);
  for(let y=0;y<nativeRows;y++){
    for(let x=0;x<nativeCols;x++){
      fullArray[(y+offsetY)*MAX_COLS+(x+offsetX)]=arr[y*nativeCols+x];
    }
  }
  return { arr: fullArray, offsetX, offsetY };
}

function saveCanvasFile(canvas, label){
  canvas.toBlob(blob=>{
    const ts=(new Date()).toISOString().replace(/[:T]/g,'-').split('.')[0];
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=label?`pixie-${label}-${ts}.png`:`pixie-${ts}.png`;
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

function savePNGs(){
  if(!lastImageArray) return;
  // Small PNG
  hiddenCanvas.width = currentCols;
  hiddenCanvas.height = currentRows;
  let ctx = hiddenCanvas.getContext('2d');
  ctx.clearRect(0,0,currentCols,currentRows);
  for(let y=0;y<currentRows;y++){
    for(let x=0;x<currentCols;x++){
      const v=lastImageArray[y*currentCols+x];
      ctx.fillStyle=getColor(v);
      ctx.fillRect(x,y,1,1);
    }
  }
  saveCanvasFile(hiddenCanvas,'');

  // Upscaled PNG
  const scale=Math.min(1920/currentCols,1080/currentRows);
  const bigW=Math.max(1,Math.round(currentCols*scale));
  const bigH=Math.max(1,Math.round(currentRows*scale));
  hiddenCanvas.width=bigW;
  hiddenCanvas.height=bigH;
  ctx=hiddenCanvas.getContext('2d');
  ctx.clearRect(0,0,bigW,bigH);
  const cellW=bigW/currentCols;
  const cellH=bigH/currentRows;
  for(let y=0;y<currentRows;y++){
    for(let x=0;x<currentCols;x++){
      const v=lastImageArray[y*currentCols+x];
      ctx.fillStyle=getColor(v);
      ctx.fillRect(x*cellW,y*cellH,cellW,cellH);
    }
  }
  saveCanvasFile(hiddenCanvas,'upscaled');
}

function handleImage(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      lastImage=img;
      const {arr,cols,rows}=processImage(img);
      drawImage(arr,cols,rows);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

function handleJSON(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const j=JSON.parse(e.target.result);
      lastDroppedJson=j;
      if(j.data && j.data.length){
        let nativeCols=Math.round(Math.sqrt(j.data.length*MAX_COLS/MAX_ROWS));
        let nativeRows=Math.round(j.data.length/nativeCols);
        const arr=Array.from(j.data).map(c=>parseInt(c));
        const {arr:fullArr}=padTo160x90(arr,nativeCols,nativeRows); // JSON letterbox
        drawImage(fullArr,MAX_COLS,MAX_ROWS);
      }
    }catch(err){ console.warn('Failed to parse JSON',err); }
  };
  reader.readAsText(file);
}

function handleFile(file){
  const types=['image/png','image/jpeg','image/jpg','image/bmp','image/webp','image/gif','image/avif'];
  if(types.includes(file.type)) handleImage(file);
  else if(file.type==='application/json') handleJSON(file);
}

window.addEventListener('dragover',e=>e.preventDefault());
window.addEventListener('drop',e=>{
  e.preventDefault();
  if(e.dataTransfer.files.length>0) handleFile(e.dataTransfer.files[0]);
});

let xPressCount=0, firstXTime=null;
window.addEventListener('keydown',e=>{
  if(e.key && e.key.toLowerCase()==='x'){
    const now=Date.now();
    if(firstXTime===null||(now-firstXTime)>500){ firstXTime=now; xPressCount=1; }
    else xPressCount++;
    if(xPressCount===3){
      if(lastImageArray){
        const s=JSON.stringify({data:lastImageArray.join('')});
        const blob=new Blob([s],{type:'application/json'});
        const ts=(new Date()).toISOString().replace(/[:T]/g,'-').split('.')[0];
        const a=document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=`pixie-${ts}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      }
      xPressCount=0; firstXTime=null;
    }
  }
});

window.addEventListener('keydown',e=>{
  if(e.code==='Space'){
    blackMode=!blackMode;
    document.body.style.background=blackMode?'#222':'#1a1a4d';
    if(lastImage){
      const {arr,cols,rows}=processImage(lastImage);
      drawImage(arr,cols,rows);
    } else if(lastDroppedJson){
      const arr=Array.from(lastDroppedJson.data).map(c=>parseInt(c));
      let nativeCols=Math.round(Math.sqrt(arr.length*MAX_COLS/MAX_ROWS));
      let nativeRows=Math.round(arr.length/nativeCols);
      const {arr:fullArr}=padTo160x90(arr,nativeCols,nativeRows);
      drawImage(fullArr,MAX_COLS,MAX_ROWS);
    }
  } else if(e.key==='Enter'){ savePNGs(); }
});
</script>
</body>
</html>
