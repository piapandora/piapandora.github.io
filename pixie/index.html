<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixie Squares</title>
<link rel="icon" type="image/png" href="misc/icons8-feather-55.png">
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{
    height:100%;width:100%;
    background:#1a1a4d; /* initial dark blue */
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;position:relative;
    color:white;font-family:sans-serif;font-size:1.5rem;
  }
  #grid{
    display:grid;
    width:calc(min(100vw / 160, 100vh / 90) * 160);
    height:calc(min(100vw / 160, 100vh / 90) * 90);
    grid-template-columns:repeat(160,1fr);
    grid-template-rows:repeat(90,1fr);
    gap:0;
  }
  .cell{width:100%;height:100%;}

  /* Blue palette */
  .c-0 { background: #1a1a4d; }
  .c-1 { background: #1a1a4d; }
  .c-2 { background: #2a2a66; }
  .c-3 { background: #3b3b80; }
  .c-4 { background: #5555a0; }
  .c-5 { background: #7070b8; }
  .c-6 { background: #8c8cd0; }
  .c-7 { background: #a8a8e6; }
  .c-8 { background: #ccccff; }
  .c-9 { background: #ccccff; }

  #message{
    position:absolute;
    top:50%;left:50%;
    transform:translate(-50%,-50%);
    pointer-events:none;
  }
</style>
</head>
<body>

<div id="grid"></div>
<div id="message">Drop Image or JSON</div>

<script>
const COLS = 160;
const ROWS = 90;
const TOTAL = COLS * ROWS;
const grid = document.getElementById('grid');
const message = document.getElementById('message');
let lastImageArray = null;

// Convert brightness to index
function brightnessToIndex(r,g,b){
  const bright = (r+g+b)/3;
  const step = Math.floor(bright / 26);
  return Math.min(step,9);
}

// Draw the grid
function drawImage(imageArray){
  lastImageArray = imageArray;
  message.style.display='none'; // hide message
  grid.innerHTML='';
  const frag = document.createDocumentFragment();
  for(let i=0;i<TOTAL;i++){
    const div = document.createElement('div');
    div.className='cell c-'+imageArray[i];
    frag.appendChild(div);
  }
  grid.appendChild(frag);
}

// Process image
function processImage(img){
  const canvas = document.createElement('canvas');
  canvas.width = COLS;
  canvas.height = ROWS;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img,0,0,COLS,ROWS);
  const data = ctx.getImageData(0,0,COLS,ROWS).data;
  let arr = [];
  for(let i=0;i<data.length;i+=4){
    arr.push(brightnessToIndex(data[i],data[i+1],data[i+2]));
  }
  return arr;
}

// Download JSON
function downloadJSON(arr){
  if(!arr) return;
  const dataStr = JSON.stringify({ data: arr.join('') });
  const blob = new Blob([dataStr], { type: 'application/json' });

  const now = new Date();
  const timestamp = now.toISOString().replace(/[:T]/g,'-').split('.')[0];
  const filename = `pixie-${timestamp}.json`;

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

// Handle files
function handleImage(file){
  const reader = new FileReader();
  reader.onload = e=>{
    const img = new Image();
    img.onload = ()=>{
      const arr = processImage(img);
      drawImage(arr);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function handleJSON(file){
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const json = JSON.parse(e.target.result);
      if(json.data && json.data.length===TOTAL){
        const arr = Array.from(json.data).map(c=>parseInt(c));
        drawImage(arr);
      } else { console.warn('Invalid JSON'); }
    } catch(err){ console.warn('Failed to parse JSON',err); }
  };
  reader.readAsText(file);
}

function handleFile(file){
  const supportedTypes = [
    'image/png','image/jpeg','image/jpg',
    'image/bmp','image/webp','image/gif','image/avif'
  ];
  if(supportedTypes.includes(file.type)) handleImage(file);
  else if(file.type==='application/json') handleJSON(file);
  else console.warn('Unsupported file type:', file.type);
}

// Drag-and-drop
window.addEventListener('dragover',e=>e.preventDefault());
window.addEventListener('drop',e=>{
  e.preventDefault();
  if(e.dataTransfer.files.length>0) handleFile(e.dataTransfer.files[0]);
});

// Download
let xPressCount = 0;
window.addEventListener('keydown', e=>{
  if(e.key.toLowerCase()==='x'){
    xPressCount++;
    if(xPressCount===3){
      downloadJSON(lastImageArray);
      xPressCount = 0;
    }
  } else {
    xPressCount = 0;
  }
});
</script>

</body>
</html>